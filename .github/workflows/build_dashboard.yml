name: build-dashboard
true:
  workflow_dispatch: {}
  push:
    branches:
    - main
    paths:
    - '**/*.py'
    - config/**
    - site/**
  schedule:
  - cron: 0 6 1 1,4,7,10 *
permissions:
  contents: write
  pages: write
  id-token: write
concurrency:
  group: pages
  cancel-in-progress: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install -r requirements.txt

        '
    - name: Run pipeline (build Excel + curated CSVs + site JSON)
      env:
        CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
        EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
      run: 'python pipeline.py

        '
    - name: Upload workbook artifact
      uses: actions/upload-artifact@v4
      with:
        name: HI_dashboard_auto_demo
        path: output/HI_dashboard_auto_demo.xlsx
    - name: Commit curated CSVs back to repo
      run: "git config user.name \"github-actions[bot]\"\ngit config user.email \"\
        github-actions[bot]@users.noreply.github.com\"\ngit add data/curated/*.csv\
        \ || true\nif git diff --cached --quiet; then\n  echo \"No data changes to\
        \ commit.\"\nelse\n  git commit -m \"data: refresh curated CSVs [skip ci]\"\
        \n  git pull --rebase\n  git push\nfi\n"
    - name: Upload static site artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: site
    env:
      CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
      EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
      FBI_API_KEY: ${{ secrets.FBI_API_KEY }}
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
